)
1.755/2.39
source("../../R/fix_phenofit.R")
devtools::load_all(".")
df
df$QC_flag
# lambda   <- 5    # non-parameter Whittaker, only suit for 16-day. Other time-scale
# should assign a lambda.
ymax_min   <- 0.1  # the maximum ymax shoud be greater than `ymax_min`
rymin_less <- 0.8  # trough < ymin + A*rymin_less
nptperyear <- 36   # How many points for a single year
wFUN       <- wTSM #wTSM #wBisquare # Weights updating function, could be one of `wTSM`, 'wBisquare', `wChen` and `wSELF`.
methods = c("AG", "Zhang", "Beck", "Elmore")
fit  <- curvefits(INPUT, brks2,
methods = methods, #,"klos",, 'Gu'
wFUN = wFUN,
nextend = 2, maxExtendMonth = 3, minExtendMonth = 1, minPercValid = 0.2,
print = print, verbose = FALSE)
# 2680 ms
## check the curve fitting parameters
l_param <- get_param(fit)
print(str(l_param, 1))
print(l_param$AG)
d_fit <- get_fitting(fit)
## Get GOF information
d_gof <- get_GOF(fit)
# fit$stat <- stat
print(head(d_gof))
# print(fit$fits$AG$`2002_1`$ws)
print(fit$`2002_1`$fFIT$AG$ws)
## visualization
# svg("Figure1_phenofit_curve_fitting.svg", 11, 7)
# Cairo::CairoPDF(file_pdf, 11, 6) #
# dev.off()
g <- plot_phenofit(d_fit, brks2, titlestr)
grid::grid.newpage(); grid::grid.draw(g)# plot to check the curve fitting
?curvefits
methods = c("AG", "Zhang", "Beck", "Elmore")
fit  <- curvefits(INPUT, brks2,
methods = methods, #,"klos",, 'Gu'
wFUN = wFUN,
iters = 3,
nextend = 2, maxExtendMonth = 3, minExtendMonth = 1, minPercValid = 0.2,
print = print, verbose = FALSE)
# 2680 ms
## check the curve fitting parameters
l_param <- get_param(fit)
print(str(l_param, 1))
print(l_param$AG)
d_fit <- get_fitting(fit)
## Get GOF information
d_gof <- get_GOF(fit)
# fit$stat <- stat
print(head(d_gof))
# print(fit$fits$AG$`2002_1`$ws)
print(fit$`2002_1`$fFIT$AG$ws)
## visualization
# svg("Figure1_phenofit_curve_fitting.svg", 11, 7)
# Cairo::CairoPDF(file_pdf, 11, 6) #
# dev.off()
g <- plot_phenofit(d_fit, brks2, titlestr)
grid::grid.newpage(); grid::grid.draw(g)# plot to check the curve fitting
l_pheno
l_pheno$doy %>% melt_list("metho")
r <- l_pheno$doy %>% melt_list("metho")
?add_HeadTail
df
lst
devtools::load_all(".")
sites
d
nlst
lst
qc_SPOT(qc, wmin = 0.2)
devtools::load_all(".")
use_git_ignore(".Rhistory")
use_git_ignore("*.png")
d
lst_pheno <- foreach(d = lst, site = names(lst), i = icount(1)) %do% {
titlestr = glue("[{i}] {site}")
d_qc = qc_SPOT(qc, wmin = 0.2)
phenofit_site <- function(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
}
titlestr = glue("[{i}] {site}")
lst_pheno <- foreach(d = lst, site = names(lst), i = icount(1)) %do% {
# titlestr = glue("[{i}] {site}")
# d_qc = qc_SPOT(qc, wmin = 0.2)
# phenofit_site <- function(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
#     nptperyear = 36,
#     prefix = "", titlestr = titlestr, show = TRUE)
}
site
lst
names(lst)
lst %<>% set_names(sp$VId[-I_bad])
lst_pheno <- foreach(d = lst, site = names(lst), i = icount(1)) %do% {
# titlestr = glue("[{i}] {site}")
# d_qc = qc_SPOT(qc, wmin = 0.2)
# phenofit_site <- function(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
#     nptperyear = 36,
#     prefix = "", titlestr = titlestr, show = TRUE)
}
sitee
site
lst_pheno <- foreach(d = lst, site = names(lst), i = icount(1)) %do% {
titlestr = glue("[{i}] {site}")
d_qc = qc_SPOT(qc, wmin = 0.2)
# phenofit_site <- function(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
#     nptperyear = 36,
#     prefix = "", titlestr = titlestr, show = TRUE)
}
devtools::load_all(".")
ans = phenofit_site(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
check_dir
devtools::load_all(".")
lst_pheno <- foreach(d = lst, site = names(lst), i = icount(1)) %do% {
titlestr = glue("[{i}] {site}")
d_qc = qc_SPOT(qc, wmin = 0.2)
ans = phenofit_site(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
}
d
d
table(d$qc)
table(d_qc$QC_flag)
as.numeric(d_qc$QC_flag)
as.numeric(d_qc$QC_flag) %>% range()
load_all("../..")
devtools::load_all(".")
ans = phenofit_site(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
devtools::load_all(".")
devtools::load_all(".")
ans = phenofit_site(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
nmax_points <- factor(QC_flag) %>% as.numeric() %>% max(na.rm = T)
nmax_points
nmax_points <- ifelse(nmax_points <= 4, 4, 6)
nmax_points
make_legend(linename , linecolor, nmax_points = nmax_points, ...)
lgd = make_legend(linename , linecolor, nmax_points = nmax_points, ...)
write_fig(lgd, "a.pdf")
devtools::load_all("../..")
devtools::load_all("../..")
ans = phenofit_site(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
lst_pheno <- foreach(d = lst, site = names(lst), i = icount()) %do% {
titlestr = glue("[{i}] {site}")
d_qc = qc_SPOT(qc, wmin = 0.2)
ans = phenofit_site(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
}
fid
dates
date
# 27
VI_qc = ncvar_get(fid, "VI_quality", start = c(1, 27), count = c(-1, 1)) # 1998-08-26, all pixel
vals <- getBits(VI_qc, 0, 2)
table(vals)
plot(r)
plot(r)
# grid     = get_grid(range, cellsize)
# gridclip <- grid[I_grid_fix, ]
# r <- raster(gridclip) # gridId has changed
r = get_grid2(range, cellsize) %>% mask_notin(I_grid)
plot(r)
dev.off()
dev.off()
plot(r)
cellsize
I_grid
# grid     = get_grid(range, cellsize)
# gridclip <- grid[I_grid_fix, ]
# r <- raster(gridclip) # gridId has changed
r = get_grid2(range, cellsize) %>% mask_notin(I_grid)
# gridclip$id <- 1
plot(r)
class(r)
r = get_grid2(range, cellsize) %>% mask_notin(I_grid)
r
plot(r)
r[I_grid] <- vals
plot(r)
source("../../test/load_pkgs.R")
source("../../R/fix_phenofit.R")
# directory for images
check_dir("images")
file = "G:/Github/phenology/China_Phenology/TP_phenology/clipTP_nc/grid_nc/NDVI_SPOT_TP_GRID.nc"
fid  <- nc_open(file)
mat_grid    <- ncvar_get(fid, "grid")
I_grid      <- fid$dim$Id$vals %>% set_dim(NULL)
# I_grid_fix  <- fix_Igrid(mat_grid, I_grid)
# 27
VI_qc = ncvar_get(fid, "VI_quality", start = c(1, 27), count = c(-1, 1)) # 1998-08-26, all pixel
vals <- getBits(VI_qc, 0, 2)
# SpatialGrids
range    = c(73, 105, 25, 40)
cellsize = 1/112
# grid     = get_grid(range, cellsize)
# gridclip <- grid[I_grid_fix, ]
# r <- raster(gridclip) # gridId has changed
r = get_grid2(range, cellsize) %>% mask_notin(I_grid)
# gridclip$id <- 1
plot(r)
snow <- vals == 4
r[I_grid] <- snow
plot(r)
dates
date
par(mrow = c(2, 3))
par(mfrow = c(2, 3))
plot(r)
plot(r)
plot(r, title="d")
plot(r, main="d")
d_date <- fread("N:/Research/phenology/phenology_TP/inst/extdata/dates_SPOT.txt")
date = as.POSIXct(d_date$mid) %>% date()
d_date
d_date
d_date <- fread("N:/Research/phenology/phenology_TP/inst/extdata/dates_SPOT.txt") %>% cbind(I = 1:nrow(.), .)
d_date
d_date[ingrow == 0]
d_nongrow = d_date[ingrow == 0]
d_nongrow
d_nongrow$mid %>% as.POSIXct()
d_nongrow$mid %>% as.POSIXct() %>% date()
par(mfrow = c(2, 3))
d_nongrow
d_nongrow$I
d_nongrow$I[i]
par(mfrow = c(2, 3))
d_nongrow = d_date[ingrow == 0]
foreach(i = 1:nrow(d_nongrow), icount(6)) %do% {
datei = d_nongrow$mid %>% as.POSIXct() %>% date()
I_time = d_nongrow$I[i]
VI_qc = ncvar_get(fid, "VI_quality", start = c(1, I_time), count = c(-1, 1)) # 1998-08-26, all pixel
vals <- getBits(VI_qc, 0, 2)
snow <- vals == 4
r[I_grid] <- snow
plot(r, main = datei)
}
par(mfrow = c(2, 3))
d_nongrow = d_date[ingrow == 0]
foreach(i = 1:nrow(d_nongrow), icount(6)) %do% {
datei = d_nongrow$mid[i] %>% as.POSIXct() %>% date()
I_time = d_nongrow$I[i]
VI_qc = ncvar_get(fid, "VI_quality", start = c(1, I_time), count = c(-1, 1)) # 1998-08-26, all pixel
vals <- getBits(VI_qc, 0, 2)
snow <- vals == 4
r[I_grid] <- snow
plot(r, main = datei)
}
par(mfrow = c(2, 3), mar = c(3, 2, 2, 1), mgp = c(3, 0.6, 0))
d_nongrow = d_date[ingrow == 0]
foreach(i = 1:nrow(d_nongrow), icount(6)) %do% {
datei = d_nongrow$mid[i] %>% as.POSIXct() %>% date()
I_time = d_nongrow$I[i]
VI_qc = ncvar_get(fid, "VI_quality", start = c(1, I_time), count = c(-1, 1)) # 1998-08-26, all pixel
vals <- getBits(VI_qc, 0, 2)
snow <- vals == 4
r[I_grid] <- snow
plot(r, main = datei)
}
par(mfrow = c(2, 3), mar = c(3, 2, 2, 1), mgp = c(3, 0.6, 0))
d_nongrow = d_date[ingrow == 0]
foreach(i = 1:nrow(d_nongrow), icount(6)) %do% {
datei = d_nongrow$mid[i] %>% as.POSIXct() %>% date()
I_time = d_nongrow$I[i]
VI_qc = ncvar_get(fid, "VI_quality", start = c(1, I_time), count = c(-1, 1)) # 1998-08-26, all pixel
vals <- getBits(VI_qc, 0, 2)
snow <- vals == 4
r[I_grid] <- snow
plot(r, main = datei)
}
par(mfrow = c(2, 3), mar = c(3, 2, 2, 1), mgp = c(3, 0.6, 0))
d_nongrow = d_date[ingrow == 0]
foreach(i = 27:nrow(d_nongrow), icount(12)) %do% {
datei = d_date$mid[i] %>% as.POSIXct() %>% date()
I_time = d_date$I[i]
VI_qc = ncvar_get(fid, "VI_quality", start = c(1, I_time), count = c(-1, 1)) # 1998-08-26, all pixel
vals <- getBits(VI_qc, 0, 2)
snow <- vals == 4
r[I_grid] <- snow
plot(r, main = datei)
}
par(mfrow = c(4, 3), mar = c(3, 2, 2, 1), mgp = c(3, 0.6, 0))
d_nongrow = d_date[ingrow == 0]
foreach(i = 27:nrow(d_nongrow), icount(12)) %do% {
datei = d_date$mid[i] %>% as.POSIXct() %>% date()
I_time = d_date$I[i]
VI_qc = ncvar_get(fid, "VI_quality", start = c(1, I_time), count = c(-1, 1)) # 1998-08-26, all pixel
vals <- getBits(VI_qc, 0, 2)
snow <- vals == 4
r[I_grid] <- snow
plot(r, main = datei)
}
a
i
length(I_grid)
chunk
l <- chunk(seq_along(I_grid), 100)
l <- chunk(seq_along(I_grid), 200)
l <- chunk(seq_along(I_grid), 400)
l <- chunk(seq_along(I_grid), 1000)
fid
327*5
length(I_grid)/327
length(I_grid)/(327*5)
?glue
glue("{format(i, '%03d')}")
u
i = 1
glue("{format(i, '%03d')}")
glue('{format(i, "%03d"")}')
i
glue('{format(i, "%03d"")}')
glue('{format(1, "%03d"")}')
glue('{format(100, "%03d"")}')
name <- "Fred"
age <- 50
anniversary <- as.Date("1991-10-12")
glue('My name is {name},',
'my age next year is {age + 1},',
'my anniversary is {format(anniversary, "%A, %B %d, %Y")}.')
glue('my anniversary is {format(anniversary, "%A, %B %d, %Y")}.')
glue('my anniversary is {format(i, "%d")}.')
glue('my anniversary is {format(i, "%0d")}.')
glue('my anniversary is {format(x, "%0d")}.')
x  = 10
glue('my anniversary is {format(x, "%0d")}.')
glue('my anniversary is {format(x, "%03d")}.')
devtools::load_all(".")
devtools::load_all(".")
devtools::load_all(".")
source("test/load_pkgs.R")
# add date
d_date <- fread("N:/Research/phenology/phenology_TP/inst/extdata/dates_SPOT.txt")
date   = as.POSIXct(d_date$mid) %>% date()
# NC file
file = "G:/Github/phenology/China_Phenology/TP_phenology/clipTP_nc/grid_nc/NDVI_SPOT_TP_GRID.nc"
fid  <- nc_open(file)
mat_grid <- ncvar_get(fid, "grid")
I_grid   <- fid$dim$Id$vals %>% set_dim(NULL)
l_ind    <- chunk(seq_along(I_grid), 1000)
outdir   = "OUTPUT"
check_dir(outdir)
foreach(inds = l_ind, i = icount(1)) %do% {
I_begin  = min(inds)
n_time   = length(inds)
mat_NDVI = ncvar_get(fid, "NDVI"      , start = c(i, 1), count = c(1, -1)) %>% t()
mat_qc   = ncvar_get(fid, "VI_quality", start = c(i, 1), count = c(1, -1)) %>% t()
browser()
l_pheno = foreach(y = mat_NDVI, qc = mat_qc) %do% {
titlestr = ""
# titlestr = glue("[{i}] {site}")
d_qc = qc_SPOT(qc, wmin = 0.2)
ans  = phenofit_site <- function(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = FALSE)
}
df = l_pheno %>% set_names(inds) %>% rm_empty() %>% melt_list("I_grid")
outfile = sprintf("{outdir}/phenofit_TP_SPOT_(1998-2013)_112deg_[%04d]", outdir, i)
write(df, outfile)
}
inds
l_ind
temp <- foreach(inds = l_ind, i = icount(1)) %do% {
I_begin  = min(inds)
n_time   = length(inds)
mat_NDVI = ncvar_get(fid, "NDVI"      , start = c(i, 1), count = c(1, -1)) %>% t()
mat_qc   = ncvar_get(fid, "VI_quality", start = c(i, 1), count = c(1, -1)) %>% t()
browser()
l_pheno = foreach(y = mat_NDVI, qc = mat_qc) %do% {
titlestr = ""
# titlestr = glue("[{i}] {site}")
d_qc = qc_SPOT(qc, wmin = 0.2)
ans  = phenofit_site <- function(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = FALSE)
}
df = l_pheno %>% set_names(inds) %>% rm_empty() %>% melt_list("I_grid")
outfile = sprintf("{outdir}/phenofit_TP_SPOT_(1998-2013)_112deg_[%04d]", outdir, i)
write(df, outfile)
}
temp <- foreach(inds = l_ind, i = icount(1)) %do% {
I_begin  = min(inds)
n_time   = length(inds)
mat_NDVI = ncvar_get(fid, "NDVI"      , start = c(i, 1), count = c(1, -1)) %>% t()
mat_qc   = ncvar_get(fid, "VI_quality", start = c(i, 1), count = c(1, -1)) %>% t()
browser()
l_pheno = foreach(y = mat_NDVI, qc = mat_qc) %do% {
titlestr = ""
# titlestr = glue("[{i}] {site}")
d_qc = qc_SPOT(qc, wmin = 0.2)
# if titlestr == NULL, then no figure produced; if show, then it will be open
ans = phenofit_site(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
}
df = l_pheno %>% set_names(inds) %>% rm_empty() %>% melt_list("I_grid")
outfile = sprintf("{outdir}/phenofit_TP_SPOT_(1998-2013)_112deg_[%04d]", outdir, i)
write(df, outfile)
}
mat_NDVI = ncvar_get(fid, "NDVI"      , start = c(I_begin, 1), count = c(n_time, -1)) %>% t()
mat_qc   = ncvar_get(fid, "VI_quality", start = c(I_begin, 1), count = c(n_time, -1)) %>% t()
fid
l_pheno = foreach(y = mat_NDVI, qc = mat_qc, icount(1)) %do% {
titlestr = ""
# titlestr = glue("[{i}] {site}")
d_qc = qc_SPOT(qc, wmin = 0.2)
browser()
# if titlestr == NULL, then no figure produced; if show, then it will be open
ans = phenofit_site(y = d$NDVI, t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
}
# if titlestr == NULL, then no figure produced; if show, then it will be open
ans = phenofit_site(y = y[1, ], t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
y
plot(y)
ans = phenofit_site(y = y[1, ], t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
y
y
y
ans = phenofit_site(y = y[1, ], t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
l_ind
y
devtools::load_all(".")
ans = phenofit_site(y = y[1, ], t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
brks2  <- season_mov(INPUT,
FUN = wWHIT, wFUN = wFUN,
maxExtendMonth = 6, r_min = 0.1,
IsPlot = IsPlot, IsPlot.OnlyBad = FALSE, print = print)
INPUT
y
y
y[,1]
# if titlestr == NULL, then no figure produced; if show, then it will be open
ans = phenofit_site(y = y[, 1], t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
devtools::load_all(".")
# if titlestr == NULL, then no figure produced; if show, then it will be open
ans = phenofit_site(y = y[, 1], t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
devtools::load_all(".")
titlestr = "a"
# if titlestr == NULL, then no figure produced; if show, then it will be open
ans = phenofit_site(y = y[, 1], t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
ans
l_pheno = foreach(y = mat_NDVI, qc = mat_qc, icount(1)) %do% {
titlestr = "a"
# titlestr = glue("[{i}] {site}")
d_qc = qc_SPOT(qc, wmin = 0.2)
# browser()
# if titlestr == NULL, then no figure produced; if show, then it will be open
ans = phenofit_site(y = y[, 1], t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = TRUE)
}
system.time({
l_pheno = foreach(y = mat_NDVI, qc = mat_qc, j = icount(10)) %do% {
runningId(j)
# titlestr = "a"N
# titlestr = glue("[{i}] {site}")
d_qc = qc_SPOT(qc, wmin = 0.2)
# browser()
# if titlestr == NULL, then no figure produced; if show, then it will be open
ans = phenofit_site(y = y[, 1], t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = FALSE)
}
})
length(I_grid)*26.81/10
length(I_grid)*26.81/10/86400
length(I_grid)*26.81/10/86400/40
profvis::profvis({
l_pheno = foreach(y = mat_NDVI, qc = mat_qc, j = icount(10)) %do% {
runningId(j)
# titlestr = "a"N
# titlestr = glue("[{i}] {site}")
d_qc = qc_SPOT(qc, wmin = 0.2)
# browser()
# if titlestr == NULL, then no figure produced; if show, then it will be open
ans = phenofit_site(y = y[, 1], t = date, w = d_qc$w, QC_flag = d_qc$QC_flag,
nptperyear = 36,
prefix = "", titlestr = titlestr, show = FALSE)
}
})
source('E:/Research/phenology/phenofit/inst/phenofit.shiny/test/1. ExtractPhenology_SPOT_at_TP.R', echo=TRUE)
dir.show()
use_build_ignore("inst/extdata/")
